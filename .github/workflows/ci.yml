name: CI â€” Lint & Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install flake8 pylint
          pip install -r requirements.txt
          pip install apache-airflow==2.9.3

      - name: Run flake8
        run: flake8 dags/ plugins/ tests/ --max-line-length=120 --ignore=E501,W503

      - name: Run pylint
        run: pylint dags/ plugins/ --disable=C0114,C0115,C0116,R0903 --max-line-length=120 || true

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install apache-airflow==2.9.3
          pip install pytest pytest-cov

      - name: Run tests
        env:
          AIRFLOW_HOME: /tmp/airflow
          AIRFLOW__CORE__LOAD_EXAMPLES: "false"
        run: |
          mkdir -p $AIRFLOW_HOME
          pytest tests/ -v --tb=short

  validate-dags:
    name: Validate DAGs
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install apache-airflow==2.9.3

      - name: Validate DAG files
        env:
          AIRFLOW_HOME: /tmp/airflow
          AIRFLOW__CORE__LOAD_EXAMPLES: "false"
        run: |
          mkdir -p $AIRFLOW_HOME
          python -c "
          from airflow.models import DagBag
          bag = DagBag(dag_folder='dags/', include_examples=False)
          assert len(bag.import_errors) == 0, f'DAG import errors: {bag.import_errors}'
          print(f'Successfully loaded {len(bag.dags)} DAG(s)')
          "

  validate-config:
    name: Validate YAML Config
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install pyyaml jsonschema

      - name: Validate sources.yaml
        run: |
          python -c "
          import yaml, jsonschema, json, sys
          schema_path = 'dags/config/sources_schema.json'
          config_path = 'dags/config/sources.yaml'
          with open(schema_path) as f:
              schema = json.load(f)
          with open(config_path) as f:
              config = yaml.safe_load(f)
          try:
              jsonschema.validate(config, schema)
              print('Config validation passed')
          except jsonschema.ValidationError as e:
              print(f'Config validation FAILED: {e.message}', file=sys.stderr)
              sys.exit(1)
          "
